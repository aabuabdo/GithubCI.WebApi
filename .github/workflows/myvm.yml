name: Build and Deploy .NET App to IIS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:

      # 1ï¸âƒ£ Checkout Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ ØªØ«Ø¨ÙŠØª .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # 3ï¸âƒ£ Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # 4ï¸âƒ£ Build project
      - name: Build project
        run: dotnet build --configuration Release --no-restore

      # 5ï¸âƒ£ Run unit tests
      - name: Run tests
        run: dotnet test --no-build --verbosity normal

      # 6ï¸âƒ£ Publish application
      - name: Publish application
        run: dotnet publish -c Release -o ./publish

      # 7ï¸âƒ£ Deploy to IIS (Ù…ÙØµØ­Ø­ âœ…)
      - name: Deploy to IIS
        shell: powershell
        run: |
          Import-Module WebAdministration

          $siteName = "MyApp"
          $physicalPath = "C:\inetpub\wwwroot\MyApp"
          $appPoolName = "MyAppPool"

          Write-Host "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø± Ù„Ù€ $siteName" -ForegroundColor Green

          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
          if (-not (Test-Path $physicalPath)) {
              New-Item -Path $physicalPath -ItemType Directory -Force
              Write-Host "ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯: $physicalPath" -ForegroundColor Yellow
          }

          # Ø¥Ù†Ø´Ø§Ø¡ App Pool Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
          if (-not (Test-Path "IIS:\AppPools\$appPoolName")) {
              New-Item IIS:\AppPools\$appPoolName
              Write-Host "ğŸ³ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ App Pool: $appPoolName" -ForegroundColor Yellow
          }

          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
          if (-not (Get-ChildItem IIS:\Sites | Where-Object { $_.Name -eq $siteName })) {
              New-Item -Path "IIS:\Sites\$siteName" -physicalPath $physicalPath -bindings @{protocol="http";bindingInformation="*:8080:"}
              Set-ItemProperty "IIS:\Sites\$siteName" -Name applicationPool -Value $appPoolName
              Write-Host "ğŸŒ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹: $siteName" -ForegroundColor Yellow
          }

          # ğŸ”§ Ø¥ÙŠÙ‚Ø§Ù Ø¢Ù…Ù† Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„Ø©
          Write-Host "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª..." -ForegroundColor Cyan
          
          # ÙØ­Øµ ÙˆØ¥ÙŠÙ‚Ø§Ù App Pool
          $appPool = Get-WebAppPoolState -Name $appPoolName
          if ($appPool.Value -eq "Started") {
              Stop-WebAppPool $appPoolName
              Write-Host "âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù App Pool: $appPoolName" -ForegroundColor Green
          } else {
              Write-Host "â„¹ï¸ App Pool Ù…ÙØ·ÙØ£ Ø¨Ø§Ù„ÙØ¹Ù„: $appPoolName" -ForegroundColor Gray
          }

          # ÙØ­Øµ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹
          $siteState = Get-WebsiteState -Name $siteName
          if ($siteState.Value -eq "Started") {
              Stop-Website $siteName
              Write-Host "âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙˆÙ‚Ø¹: $siteName" -ForegroundColor Green
          } else {
              Write-Host "â„¹ï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ÙØ·ÙØ£ Ø¨Ø§Ù„ÙØ¹Ù„: $siteName" -ForegroundColor Gray
          }

          Start-Sleep -Seconds 3

          # ğŸ“ Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Robocopy
          Write-Host "ğŸ“¤ Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª..." -ForegroundColor Cyan
          $robocopyResult = robocopy .\publish $physicalPath /MIR /NFL /NDL /NJH /NJS /nc /ns /np
          if ($LASTEXITCODE -le 3) {
              Write-Host "âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­" -ForegroundColor Green
          } else {
              Write-Host "âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ù…Ù„ÙØ§Øª: $LASTEXITCODE" -ForegroundColor Red
              exit 1
          }

          # â–¶ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¢Ù…Ù†
          Write-Host "â–¶ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª..." -ForegroundColor Cyan
          
          Start-WebAppPool $appPoolName
          Write-Host "âœ… ØªÙ… ØªØ´ØºÙŠÙ„ App Pool: $appPoolName" -ForegroundColor Green
          
          Start-Website $siteName
          Write-Host "âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹: $siteName" -ForegroundColor Green

          Write-Host "ğŸ‰ Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØªØ§Ø­ Ø¹Ù„Ù‰: http://localhost:8080" -ForegroundColor Green

name: Deploy to Windows VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: windows-latest   # مهم: runner Windows
    steps:
      # 1️⃣ سحب ملفات المستودع
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ نشر الملفات على Windows VM باستخدام PowerShell Remoting
      - name: Deploy via WinRM
        shell: pwsh
        run: |
          # تحويل كلمة المرور إلى SecureString
          $password = ConvertTo-SecureString "${{ secrets.SERVER_PASSWORD }}" -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ("${{ secrets.SERVER_USER }}", $password)

          # تنفيذ العمليات على الـ VM
          Invoke-Command -ComputerName ${{ secrets.SERVER_HOST }} -Credential $cred -ScriptBlock {
              # 1️⃣ إنشاء مجلد إذا لم يكن موجود
              $destination = "C:\AppFolder"
              if (-not (Test-Path $destination)) {
                  New-Item -ItemType Directory -Path $destination
              }

              # 2️⃣ نسخ كل الملفات من مجلد مؤقت على VM
              $source = "C:\GitHubActions\*"
              Copy-Item -Path $source -Destination $destination -Recurse -Force

              # 3️⃣ مثال: تشغيل سكربت أو إعادة تشغيل خدمة
              # Restart-Service MyService
              Write-Host "Deployment complete!"
          }
